<!DOCTYPE html>
<html lang="en">
    <head>
        <script src="http://localhost:8080/fbsql/fbsql.min.js"></script>
    </head>

    <body>
        <img id="myImage"><br><br>
        <input id="myInput" type="file" accept="image/*"><br><br>
        <button id="btnSave">Store in database</button>

        <script type="text/javascript">
        function dataURItoBlob(dataURI) {
            var arr = dataURI.split(','), mime = arr[0].match(/:(.*?);/)[1];
            return new Blob([atob(arr[1])], {type:mime});
        }
            let myImage = document.getElementById("myImage");
            let myInput = document.getElementById("myInput");
            let btnSave = document.getElementById('btnSave');

            const conn = new Connection('my-h2');
            let psSelect = conn.prepareStatement("SELECT COUNTRY_FLAG FROM COUNTRIES WHERE COUNTRY_ID = 'AU'");
            let psUpdate = conn.prepareStatement("UPDATE COUNTRIES SET COUNTRY_FLAG = :country_flag WHERE COUNTRY_ID = 'AU'");

            /* Load image from database */
            psSelect.executeQuery()
            .then(resultSet => {
//                myImage.src = resultSet[0].COUNTRY_FLAG;
            	let base64data = resultSet[0].COUNTRY_FLAG;
            	if (base64data != null)
            		myImage.src = base64data;

            });

            /* Select new image */
            myInput.onchange = function(event) {
                var input = event.target;
                var reader = new FileReader();
                reader.onload = function() {
                    //let arrayBuffer = arrayBufferToBase64(reader.result); // BINARY
                    myImage.src = reader.result;
                };
                //reader.readAsArrayBuffer(input.files[0]); // BINARY
                reader.readAsDataURL(input.files[0]);
            };

            /* Store image in the database as BLOB */
            btnSave.onclick = function() {
            	psUpdate.executeUpdate({country_flag: dataURItoBlob(myImage.src)})
                .then(result => {
                    alert("Image stored in database as BLOB.");
                });
            };
        </script>
    </body>
</html>
