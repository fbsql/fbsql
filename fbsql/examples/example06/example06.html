<!doctype html>
<html>

<head>
<title>Example 06. FBSQL: Session Attributes</title>
<script src="http://localhost:8080/fbsql.min.js"></script>
<style type="text/css">
table {
	border-color: #ddd;
	border-collapse: collapse;
}

tr {
	border: 1px solid;
	border-color: #ddd;
}

td {
	vertical-align: top;
}

td div {
	padding: 1rem;
	font-family: monospace;
	white-space: pre;
}

td div:nth-child(even) {
	background-color: #f2f2f2;
}

td div:nth-child(odd) {
	background-color: #fff;
}
</style>
</head>

<body>
	<table border="1">
		<tr>
			<td id="results"></td>
			<td id="events"></td>
		</tr>
	</table>
	<script type="text/javascript">
        "use strict"

        let results = document.getElementById('results');
        let events = document.getElementById('events');


        /* Connect to default database instance (instance with alias name 'fbsql-default') */
        //const conn = new Connection();

        /* Connect to default database instance (instance with alias name 'fbsql-default') */
        //const conn = new Connection('fbsql-default');

        /* Connect to default database instance (instance with alias name 'fbsql-default') */
        //const conn = new Connection(null);

        /* Connect to default database instance (instance with alias name 'fbsql-default') */
        //const conn = new Connection(undefined);

        /* Connect to database instance with alias name 'h2-example02' by providing instance alias name */
        //const conn = new Connection('h2-example02');

        /* Connect to database instance with alias name 'h2-example02' providing instance URL string */
        //const conn = new Connection('http://localhost:8080/h2-example02');

        /* Connect to database instance with alias name 'h2-example02' providing instance URL object */
        //const conn = new Connection(new URL('http://localhost:8080/h2-example02'));

        /* Connect to database instance with alias name 'h2-example02', user 'john' and password 'secret' */
        //const conn = new Connection('h2-example02', 'john', 'secret');

        /* Connect to database instance with alias name 'h2-example02', user 'john', password 'secret' and role 'manager' */
        //const conn = new Connection({url: 'h2-example06', username: 'john', password: 'secret', role: 'manager', local: false});
        const connLocal = FBSQL.createRemoteConnection();
        const conn = new Connection();

        const psCreateSession        = conn.prepareStatement("CREATE SESSION");
        const psGetSessionInfo       = conn.prepareStatement("GET SESSION INFO");
        const psSetSessionAttributes = conn.prepareStatement("SET SESSION ATTRIBUTES");
        const psGetSessionAttributes = conn.prepareStatement("GET SESSION ATTRIBUTES");
        const psInvalidateSession    = conn.prepareStatement("INVALIDATE SESSION");

        let startTime = performance.now();

        let parameters;

        parameters = {first_name: 'John',     date_of_birth: new Date()};

        psCreateSession.executeUpdate()
        .then((result) => {
            let div = document.createElement('div');
            div.innerHTML = '<strong>' + psCreateSession.getStatement() + '</strong> <font color="green"><br><br>' + result.rowCount + ' record(s) updated.</font><br><br>Result object:<br><font color="brown">' + JSON.stringify(result, null, '    ') + '</font>';
            results.appendChild(div);
            return psGetSessionInfo.executeQuery();
        })
        .then((resultSet) => {
            let div = document.createElement('div');
            div.innerHTML = '<strong>' + psGetSessionInfo.getStatement() + '</strong> <font color="green"><br><br>' + resultSet.length + ' record(s) selected.</font><br><br>Result Set:<br><font color="brown">' + JSON.stringify(resultSet, null, '    ') + '</font><br>';
            results.appendChild(div);
            return psSetSessionAttributes.executeUpdate(parameters);
        })
        .then((result) => {
            let div = document.createElement('div');
            div.innerHTML = '<strong>' + psSetSessionAttributes.getStatement() + '</strong> <font color="green"><br><br>' + result.rowCount + ' record(s) updated.</font><br><br>Parameters:<br><font color="blue">' + JSON.stringify(parameters, null, '    ') + '</font><br><br>Result object:<br><font color="brown">' + JSON.stringify(result, null, '    ') + '</font>';
            results.appendChild(div);
            return psGetSessionAttributes.executeQuery();
        })
        .then((resultSet) => {
            let div = document.createElement('div');
            div.innerHTML = '<strong>' + psGetSessionAttributes.getStatement() + '</strong> <font color="green"><br><br>' + resultSet.length + ' record(s) selected.</font><br><br>Result Set:<br><font color="brown">' + JSON.stringify(resultSet, null, '    ') + '</font><br>';
            results.appendChild(div);
            return psInvalidateSession.executeUpdate();
        })
        .then((result) => {
            let div = document.createElement('div');
            div.innerHTML = '<strong>' + psInvalidateSession.getStatement() + '</strong> <font color="green"><br><br>' + result.rowCount + ' record(s) updated.</font><br><br>Result object:<br><font color="brown">' + JSON.stringify(result, null, '    ') + '</font>';
            results.appendChild(div);
            return psGetSessionInfo.executeQuery();
        })
        .then((resultSet) => {
            let div = document.createElement('div');
            div.innerHTML = '<strong>' + psGetSessionInfo.getStatement() + '</strong> <font color="green"><br><br>' + resultSet.length + ' record(s) selected.</font><br><br>Result Set:<br><font color="brown">' + JSON.stringify(resultSet, null, '    ') + '</font><br>';
            results.appendChild(div);
            return psGetSessionAttributes.executeQuery();
        })
        .then((resultSet) => {
            let div = document.createElement('div');
            div.innerHTML = '<strong>' + psGetSessionAttributes.getStatement() + '</strong> <font color="green"><br><br>' + resultSet.length + ' record(s) selected.</font><br><br>Result Set:<br><font color="brown">' + JSON.stringify(resultSet, null, '    ') + '</font><br>';
            results.appendChild(div);
        })
        .catch((error)=> {
            let div = document.createElement('div');
            div.innerHTML = '<font color="red">ERROR:<br>' + JSON.stringify(error, null, '    ') + '</font>';
            results.appendChild(div);
        })
        .finally(()=> {
            let div = document.createElement('div');
            div.innerHTML = '<font color="darkcyan">*** Elapsed time: ' + ((performance.now() - startTime) / 1000) + ' seconds ***</font>';
            results.appendChild(div);
        });
    </script>
</body>

</html>
