<!doctype html>
<html>

<head>
<title>Example 07. FBSQL: Local In-Memory Database</title>
<script src="http://localhost:8080/fbsql/fbsql.min.js"></script>
<style type="text/css">
table {
	border-color: #ddd;
	border-collapse: collapse;
}

tr {
	border: 1px solid;
	border-color: #ddd;
}

td {
	vertical-align: top;
}

td div {
	padding: 1rem;
	font-family: monospace;
	white-space: pre;
}

td div:nth-child(even) {
	background-color: #f2f2f2;
}

td div:nth-child(odd) {
	background-color: #fff;
}
</style>
</head>

<body>

<div id="my" hidden>
	CREATE TABLE IF NOT EXISTS test (
		language	INT,
		hello		VARCHAR(50)
)
</div>
<button id="btn_create_table">Create Table</button>
<button id="btn_insert_records">Insert Records</button>
	<table border="1">
		<tr>
			<td id="results"></td>
			<td id="events"></td>
		</tr>
	</table>
	<script type="text/javascript">
        "use strict"

        let results = document.getElementById('results');
        let events = document.getElementById('events');


        /* Connect to default database instance (instance with alias name 'fbsql-default') */
        //const conn = new Connection();

        /* Connect to default database instance (instance with alias name 'fbsql-default') */
        //const conn = new Connection('fbsql-default');

        /* Connect to default database instance (instance with alias name 'fbsql-default') */
        //const conn = new Connection(null);

        /* Connect to default database instance (instance with alias name 'fbsql-default') */
        //const conn = new Connection(undefined);

        /* Connect to database instance with alias name 'h2-example02' by providing instance alias name */
        //const conn = new Connection('h2-example02');

        /* Connect to database instance with alias name 'h2-example02' providing instance URL string */
        //const conn = new Connection('http://localhost:8080/h2-example02');

        /* Connect to database instance with alias name 'h2-example02' providing instance URL object */
        //const conn = new Connection(new URL('http://localhost:8080/h2-example02'));

        /* Connect to database instance with alias name 'h2-example02', user 'john' and password 'secret' */
        //const conn = new Connection('h2-example02', 'john', 'secret');

        /* Connect to database instance with alias name 'h2-example02', user 'john', password 'secret' and role 'manager' */


// console.log(alasql("CREATE TABLE test (language INT, hello STRING)"));
// console.log(alasql("INSERT INTO test VALUES (1,'Hello!')"));
// console.log(alasql("INSERT INTO test VALUES (2,'Aloha!')"));
// console.log(alasql("INSERT INTO test VALUES (3,'Bonjour!')"));
// console.log( alasql("SELECT * FROM test WHERE language > :k", {k: 0}) );


let dt = [{a:1},{a:2},{a:3},{a:4},{a:5}];

		let startTime = performance.now();

       // const connLocal = new Connection({local: false});
        //const connLocal = FBSQL.connectLocal('mmm');
        
        //const connLocal = FBSQL.connectMemory('mmm');
        //const connLocal = FBSQL.connectLocalStorage('mmm');
        const conn = FBSQL.connectIndexedDb('mmm');
        /* Listen to database events */
        conn.setEventListener((event) => {
            let div = document.createElement('div');
            div.innerHTML = 'Database event received:<br><font color="darkcyan">' + JSON.stringify(event, null, '\t') + '</font>';
            events.appendChild(div);
        });

        
        //const connLocal = FBSQL.connectRemote();
        
        //let ps1 = connLocal.prepareStatement("SELECT a FROM :dt WHERE a > :rrr");
//let ps1 = connLocal.prepareStatement("CREATE TABLE test (language INT, hello STRING)");
//let ps0 = connLocal.prepareStatement("CREATE DATABASE test252");
//let ps1 = connLocal.prepareStatement("CREATE TABLE test (language INT, hello VARCHAR(50))");
//let ps0 = connLocal.prepareStatement(cr);
let ps1 = conn.prepareStatement(my);
let ps2 = conn.prepareStatement("INSERT INTO test (language, hello) VALUES (1,'Hello!')");
let ps3 = conn.prepareStatement("INSERT INTO test (language, hello) VALUES (2,'Aloha!')");
let ps4 = conn.prepareStatement("INSERT INTO test (language, hello) VALUES (3,'Bonjour!')");
let ps5 = conn.prepareStatement("INSERT INTO test (language, hello) VALUES (:lang, :hl)");
let psSelect = conn.prepareStatement("SELECT * FROM test WHERE language > :rrr");
let psSelectAll = conn.prepareStatement("SELECT * FROM test");
//let psSelectAll = connLocal.prepareStatement("SELECT * FROM CSV('a.csv', {headers:true, separator:','})");

//let psSelect = connLocal.prepareStatement("SELECT * FROM test WHERE language > ?");
//let psSelect = connLocal.prepareStatement("SELECT * FROM test");
        
        document.getElementById("btn_create_table")
        .addEventListener('click', event => {
			ps1.executeUpdate()
			.then((result) => {
				let div = document.createElement('div');
				div.innerHTML = '<strong>' + ps1.getStatement() + '</strong> <font color="green"><br><br>' + result.rowCount + ' record(s) updated.</font><br><br>Result Set:<br><font color="brown">' + JSON.stringify(result, null, '    ') + '</font><br>';
				results.appendChild(div);
			})
			.catch((error)=> {
				console.log(error);
				let div = document.createElement('div');
				//div.innerHTML = '<font color="red">ERROR:<br>' + JSON.stringify({message: error.message}, null, '    ') + '</font>';
				div.innerHTML = '<font color="red">ERROR:<br>' + error + '</font>';
				results.appendChild(div);
			})
			.finally(()=> {
				let div = document.createElement('div');
				div.innerHTML = '<font color="darkcyan">*** Elapsed time: ' + ((performance.now() - startTime) / 1000) + ' seconds ***</font>';
				results.appendChild(div);
			});
        });

        document.getElementById("btn_insert_records")
        .addEventListener('click', event => {
			ps2.executeUpdate()
			.then((result) => {
				let div = document.createElement('div');
				div.innerHTML = '<strong>' + ps2.getStatement() + '</strong> <font color="green"><br><br>' + result.rowCount + ' record(s) updated.</font><br><br>Result Set:<br><font color="brown">' + JSON.stringify(result, null, '    ') + '</font><br>';
				results.appendChild(div);
				return ps3.executeUpdate();
			})
			.then((result) => {
				let div = document.createElement('div');
				div.innerHTML = '<strong>' + ps3.getStatement() + '</strong> <font color="green"><br><br>' + result.rowCount + ' record(s) updated.</font><br><br>Result Set:<br><font color="brown">' + JSON.stringify(result, null, '    ') + '</font><br>';
				results.appendChild(div);
				return ps4.executeUpdate();
			})
			.then((result) => {
				let div = document.createElement('div');
				div.innerHTML = '<strong>' + ps4.getStatement() + '</strong> <font color="green"><br><br>' + result.rowCount + ' record(s) updated.</font><br><br>Result Set:<br><font color="brown">' + JSON.stringify(result, null, '    ') + '</font><br>';
				results.appendChild(div);
				return ps5.executeUpdate([{lang: 7, hl: 'seven'}, {lang: 8, hl: 'vosem'}]);
			})
			.then((result) => {
				let div = document.createElement('div');
				div.innerHTML = '<strong>' + ps5.getStatement() + '</strong> <font color="green"><br><br>' + result.rowCount + ' record(s) updated.</font><br><br>Result Set:<br><font color="brown">' + JSON.stringify(result, null, '    ') + '</font><br>';
				results.appendChild(div);
				//return psSelect.executeQuery([2]);
				return psSelect.executeQuery({rrr: 2});
				//return psSelect.executeQuery();
			})
			.then((resultSet) => {
				let div = document.createElement('div');
				div.innerHTML = '<strong>' + psSelect.getStatement() + '</strong> <font color="green"><br><br>' + resultSet.length + ' record(s) selected.</font><br><br>Result Set:<br><font color="brown">' + JSON.stringify(resultSet, null, '    ') + '</font><br>';
				results.appendChild(div);
				return psSelectAll.executeQuery();
			})
			.then((resultSet) => {
				let div = document.createElement('div');
				div.innerHTML = '<strong>' + psSelectAll.getStatement() + '</strong> <font color="green"><br><br>' + resultSet.length + ' record(s) selected.</font><br><br>Result Set:<br><font color="brown">' + JSON.stringify(resultSet, null, '    ') + '</font><br>';
				results.appendChild(div);
			})
			.catch((error)=> {
				console.log(error);
				let div = document.createElement('div');
				div.innerHTML = '<font color="red">ERROR:<br>' + JSON.stringify(error, null, '    ') + '</font>';
				results.appendChild(div);
			})
			.finally(()=> {
				let div = document.createElement('div');
				div.innerHTML = '<font color="darkcyan">*** Elapsed time: ' + ((performance.now() - startTime) / 1000) + ' seconds ***</font>';
				results.appendChild(div);
			});
		});
    </script>
</body>

</html>
